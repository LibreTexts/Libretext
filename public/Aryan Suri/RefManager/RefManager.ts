"use strict";
window.addEventListener("load", async () => {
    await buildManager();
    await processReference();
});
document.querySelector("#live-tag-citationstyle-select").addEventListener("change", async () => {
    await updateManager();
});
async function buildManager() {
    const referenceModal = document.createElement("div");
    // const referenceButton = document.getElementById("referenceModalBtn");
    referenceModal.innerHTML = `
        <div id="referenceModal">
            <div id="referenceModalContent">
            <h3> Reference Manager</h3>
            <p> Import references using RIS, bibtex, json, DOI, or wikidataID formats. Click reference to copy citation id, double click to remove</p>
            <div id="referenceInput">
                <input type="text" id="referenceInput-Text" value=""/>
                <button style="margin-left: 10px" onclick="storeReference(document.getElementById('referenceInput-Text').value)">Add</button>
            </div>
            <table id="referenceDisplay"></table>
            <p id="referenceModalOutput"></p>
            </div>
        </div>
    `;
    document.body.append(referenceModal);
    // document.getElementsByClassName("elm-social-share")[0].appendChild(referenceButton);
    const modal = document.getElementById("referenceModal");
    // const btn = document.getElementById("referenceModalBtn");
    // btn.onclick = function () {
    //     modal.style.display = "block";
    // };
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    };
    await updateManager();
}

function updatePrivacy(val) {
    return;
}

async function updateManager() {
    let userRefJSON = await getRefJSON();
    let style = document.querySelector("#live-tag-citationstyle-select")!.value;
    if (style == "not-set") {
        style = "citationstyle:apa";
    }
    if (userRefJSON) {
        document.getElementById('referenceDisplay').innerHTML = "";
        let userRefArray = sortReference(userRefJSON);
        let i = 0;
        let value;
        for (value of userRefArray) {
            let reference = renderReference(value.data, "reference");
            let refDiv = document.createElement("tr");
            refDiv.className = "newReference";
            refDiv.id = `${value.id}`;
            refDiv.innerHTML = `${reference} <a id=${value.id}${i}> &#x274C; </a>`;
            document.getElementById('referenceDisplay').appendChild(refDiv);
            document.getElementById(`${value.id}`).addEventListener("click", copyReference);
            document.getElementById(`${value.id}${i}`).addEventListener("click", deleteReference);
            i++;
        }
    }
    else {
        return;
    }
}

async function getRefJSON(cp = false) {
    let coverPage = null;
    let userRefJSON;
    if (cp) {
        coverPage = await LibreTexts.getCoverpage();
    }
    try {
        userRefJSON = await LibreTexts.authenticatedFetch(coverPage, `info?dream.out.format=json`, null);
        if (userRefJSON.ok) {
            userRefJSON = await userRefJSON.json();
        }
        else {
            return false;
        }
    }
    catch (e) {
        return console.debug(e);
    }
    return userRefJSON;
}

async function putRefJSON(json:any, cp = false) {
    let coverPage = null;
    if (cp) {
        coverPage = await LibreTexts.getCoverpage();
    }
    try {
        await LibreTexts.authenticatedFetch(coverPage, `info?dream.out.format=json`, null, {
            method: "PUT",
            body: (JSON.stringify(json))
        });
    }
    catch (e) {
        return console.debug(e);
    }
    return;
}
async function copyReference() {
    let refID = this.id;
    const el = document.createElement('textarea');
    el.value = `\\#${refID}#\\`;
    el.setAttribute('readonly', '');
    el.style.position = 'absolute';
    el.style.left = '-9999px';
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    return document.getElementById("referenceModalOutput").innerText = `Citation (${refID}) copied`;
}
async function deleteReference() {
    const refIDI = this.id;
    const num = refIDI.slice(-1);
    const refID = refIDI.slice(0, -1);
    let userRefJSON = await getRefJSON();
    if (userRefJSON && userRefJSON.hasOwnProperty(refID)) {
        delete userRefJSON[refID];
        await putRefJSON(userRefJSON);
    }
    else {
        return;
    }
    document.getElementById(`${refID}`).remove();
    document.getElementById("referenceModalOutput").innerText = "Citation deleted";
}
function sortReference(refs: any) {
    let userRefArray = Object.values(refs);
    userRefArray = userRefArray.sort((a, b) => {
        if (a.citation == b.citation) {
            return 0;
        }
        else if (a.citation < b.citation) {
            return -1;
        }
        else {
            return 1;
        }
    });
    return userRefArray;
}
function renderReference(json: any, output: any) {
    //@ts-ignore
    let style = document.querySelector("#live-tag-citationstyle-select").value;
    if (style == "not-set") {
        style = "citationstyle:apa";
    }
    const Cite = citeInstance();
    const Data = new Cite(json);
    if (output === "cite") {
        return Data.format('citation', {
            template: style,
            lang: 'en-US'
        });
    }
    else if (output === "reference") {
        return Data.format('bibliography', {
            template: style,
            lang: 'en-US'
        });
    }
}
async function storeReference(data: any) {
    const Selector = document.querySelector("#live-tag-citationstyle-select");
    let Style = Selector.value;
    if (Style == "not-set") {
        Style = "citationstyle:apa";
    }
    const Cite = citeInstance();
    const Data = new Cite(data);
    const json = Data.format('data');
    const citation = Data.format('citation', {
        template: Style,
        lang: 'en-US'
    });
    const parse = JSON.parse(json);
    const path = window.location.pathname.substring(1);
    let page = document.querySelector("#pageNumberHolder > dl:nth-child(1) > dd:nth-child(2)").innerHTML;
    const lib = await LibreTexts.extractSubdomain();
    page = `${lib}-${page}`;
    const cover = await LibreTexts.getCoverpage();
    let id;
    if (parse[0].hasOwnProperty('author')) {
        if (parse[0].hasOwnProperty('issued')) {
            id = `${page}--${parse[0].author[0].family + parse[0].issued["date-parts"][0]}`;
        }
        else {
            id = `${page}--${parse[0].author[0].family + Data.prototype.getFullYear()}`;
        }
    }
    else {
        id = `${page}--${citation}`;
    }
    let reference = {
        "id": id,
        "data": parse[0],
    };
    let userRefJSON = await getRefJSON();
    if (!userRefJSON) {
        userRefJSON = {};
        userRefJSON[reference.id] = reference;
        await putRefJSON(userRefJSON);
        await putRefJSON(userRefJSON, true);
        await updateManager();
        return document.getElementById("referenceModalOutput").innerText = "Citation added";
    }
    else {
        if (!userRefJSON.hasOwnProperty(reference.id)) {
            userRefJSON[reference.id] = reference;
            if (cover !== path) {
                let bookJSON = await getRefJSON(true);
                if (bookJSON) {
                    if (!bookJSON.hasOwnProperty(reference.id)) {
                        bookJSON[reference.id] = reference;
                        await putRefJSON(bookJSON, true);
                    }
                    else { }
                }
                else {
                    bookJSON = {};
                    bookJSON[reference.id] = reference;
                    await putRefJSON(bookJSON, true);
                }
            }
            else { }
            await putRefJSON(userRefJSON);
            await updateManager();
            return document.getElementById("referenceModalOutput").innerText = "Citation added";
        }
        else {
            return document.getElementById("referenceModalOutput").innerText = "Citation already exists";
        }
    }
}
async function processReference() {
    const style = document.querySelector("#live-tag-citationstyle-select").value
    const reg = new RegExp(/(?:\\#)([\s\S]*?)(?:#\\)/gm);
    let userRefJSON = await getRefJSON();

    console.log(userRefJSON)
    const pageContent = document.getElementById("pageText").innerHTML;
    let anchoredKeys = [];
    function replaceReferenceID(ref, inputString) {
        const key = inputString.replace(new RegExp(/&nbsp;/gm), " ").replace(new RegExp(/<[\s\S]*?>/gm), "").trim();
        if (key in ref) {
            if (style == "citationstyle:acs") {
                if (!anchoredKeys.includes(key)) {
                    anchoredKeys.push(key);
                }
                let index = anchoredKeys.indexOf(key)+1;
                let reference = renderReference(ref[key].data, "reference").replace(/<[\s\S]*?>/g, "").replace(/\(\d+\)/, `(${index})`)
                //return `<a href = "#reference${index}" aria-label = "Reference ${index}" aria-describedby = "reference${index}"><sup class = "refFootnote">${index}</sup></a>`;
                return `<a tabindex = "1" aria-label = "Reference ${index}" aria-describedby = '${reference}'><sup class = "refFootnote">${index}</sup></a>`;
            }
            anchoredKeys.push(key);
            return renderReference(ref[key].data, "cite");
        }
        return "Citation not Found";
    }
    let procReference = pageContent.replace(reg, (match, offset, string) => {
        const trimmedMatch = match.substring(2, match.length - 2).trim();
        return replaceReferenceID(userRefJSON, trimmedMatch);
    });
    document.getElementById("pageText").innerHTML = procReference;
    // nested processBibliography() {} --> Unnested for now
    // pass in the ref[key] as an array? or through a for loop --> Pass the full refJson and the anchored keys
    processBibliography(userRefJSON, anchoredKeys);
}
function processBibliography(referenceJSON, anchoredKeys, mode = document.querySelector("#live-tag-citationmode-select").value) {
    //Use only the unique keys that are anchored
    let userRefArray;
    const referenceHeader = document.createElement("h2");
    referenceHeader.innerText = "";
    switch (mode) {
        case 'not-set':
        case 'citationmode:references':
            let reducedRefJSON: any = {};
            if (anchoredKeys) {
                for (let key of anchoredKeys) {
                    if (!(key in reducedRefJSON)) {
                        reducedRefJSON[key] = referenceJSON[key];
                    }
                }
            }
            userRefArray = sortReference(reducedRefJSON);
            referenceHeader.innerText = "Works Cited";
            break;
        case 'citationmode:bibliography':
            userRefArray = sortReference(referenceJSON);
            referenceHeader.innerText = "Bibliography";
            break;
        case 'citationmode:none':
        default:
            return;
    }
    const style = document.querySelector("#live-tag-citationstyle-select").value;
    const managerArea = document.createElement('div');
    const referenceArea = document.createElement('ol');
    referenceArea.className += "pageBibliography";
    //console.log(anchoredKeys);
    let value: any;
    let i = 0
    for (value of userRefArray) {
        let reference = renderReference(value.data, "reference");
        if (style == "citationstyle:acs"){
            if (!anchoredKeys.includes(value.id)){
                continue;
            }
            i++;
            reference = reference.replace(/\(\d+\)/, `(<span id = "reference${i}">${i}</span>)`);
        }
        const referenceList = document.createElement("li");
        referenceList.className += "csl-entry";
        referenceList.innerHTML = reference;
        referenceArea.appendChild(referenceList);
    }
    managerArea.appendChild(referenceHeader);
    managerArea.appendChild(referenceArea);
    document.getElementById("pageText").appendChild(managerArea);
}
function citeInstance() {
    let c = CitRequire('citation-js');
    let apaname = "citationstyle:apa";
    let apatemplate = `<?xml version="1.0" encoding="utf-8"?><style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="never" page-range-format="expanded">  <info>    <title>American Psychological Association 6th edition</title>    <title-short>APA (6th ed.)</title-short>    <id>http://www.zotero.org/styles/apa-6th-edition</id>    <link href="http://www.zotero.org/styles/apa-6th-edition" rel="self"/>    <link href="http://owl.english.purdue.edu/owl/resource/560/01/" rel="documentation"/>    <author>      <name>Simon Kornblith</name>      <email>simon@simonster.com</email>    </author>    <author>      <name> Brenton M. Wiernik</name>      <email>zotero@wiernik.org</email>    </author>    <contributor>      <name>Bruce D'Arcus</name>    </contributor>    <contributor>      <name>Curtis M. Humphrey</name>    </contributor>    <contributor>      <name>Richard Karnesky</name>      <email>karnesky+zotero@gmail.com</email>      <uri>http://arc.nucapt.northwestern.edu/Richard_Karnesky</uri>    </contributor>    <contributor>      <name>Sebastian Karcher</name>    </contributor>    <category citation-format="author-date"/>    <category field="psychology"/>    <category field="generic-base"/>    <updated>2016-09-28T13:09:49+00:00</updated>    <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>  </info>  <locale xml:lang="en">    <terms>      <term name="editortranslator" form="short">        <single>ed. &amp; trans.</single>        <multiple>eds. &amp; trans.</multiple>      </term>      <term name="translator" form="short">trans.</term>      <term name="interviewer" form="short">        <single>interviewer</single>        <multiple>interviewers</multiple>      </term>      <term name="collection-editor" form="short">        <single>series ed.</single>        <multiple>series eds.</multiple>      </term>      <term name="circa" form="short">ca.</term>      <term name="bc"> B.C.E.</term>      <term name="ad"> C.E.</term>    </terms>  </locale>  <locale xml:lang="es">    <terms>      <term name="from">de</term>    </terms>  </locale>  <locale xml:lang="de">    <terms>      <term name="et-al">et al.</term>    </terms>  </locale>  <locale xml:lang="da">    <terms>      <term name="et-al">et al.</term>    </terms>  </locale>  <locale xml:lang="nn">    <terms>      <term name="et-al">et al.</term>    </terms>  </locale>  <locale xml:lang="nl">    <terms>      <term name="et-al">et al.</term>    </terms>  </locale>  <locale xml:lang="nb">    <terms>      <term name="et-al">et al.</term>    </terms>  </locale>  <locale xml:lang="fr">    <terms>      <term name="editor" form="short">        <single>Ã©d.</single>        <multiple>Ã©ds.</multiple>      </term>    </terms>  </locale>  <macro name="container-contributors-booklike">    <choose>      <if variable="container-title">        <names variable="editor translator" delimiter=", &amp; ">          <name and="symbol" initialize-with=". " delimiter=", "/>          <label form="short" prefix=" (" text-case="title" suffix=")"/>          <substitute>            <names variable="editorial-director"/>            <names variable="collection-editor"/>            <names variable="container-author"/>          </substitute>        </names>      </if>    </choose>  </macro>  <macro name="container-contributors">    <choose>      <!-- book is here to catch software with container titles -->      <if type="book broadcast chapter entry entry-dictionary entry-encyclopedia graphic map personal_communication report speech" match="any">        <text macro="container-contributors-booklike"/>      </if>      <else-if type="paper-conference">        <choose>          <if variable="collection-editor container-author editor" match="any">            <text macro="container-contributors-booklike"/>          </if>        </choose>      </else-if>    </choose>  </macro>  <macro name="secondary-contributors-booklike">    <group delimiter="; ">      <choose>        <if variable="title">          <names variable="interviewer">            <name and="symbol" initialize-with=". " delimiter=", "/>            <label form="short" prefix=", " text-case="title"/>          </names>        </if>      </choose>      <choose>        <if variable="container-title" match="none">          <group delimiter="; ">            <names variable="container-author">              <label form="verb-short" suffix=" " text-case="title"/>              <name and="symbol" initialize-with=". " delimiter=", "/>            </names>            <names variable="editor translator" delimiter="; ">              <name and="symbol" initialize-with=". " delimiter=", "/>              <label form="short" prefix=", " text-case="title"/>            </names>          </group>        </if>      </choose>    </group>  </macro>  <macro name="secondary-contributors">    <choose>      <!-- book is here to catch software with container titles -->      <if type="book broadcast chapter entry entry-dictionary entry-encyclopedia graphic map report" match="any">        <text macro="secondary-contributors-booklike"/>      </if>      <else-if type="personal_communication">        <group delimiter="; ">          <group delimiter=" ">            <choose>              <if variable="genre" match="any">                <text variable="genre" text-case="capitalize-first"/>              </if>              <else>                <text term="letter" text-case="capitalize-first"/>              </else>            </choose>            <names variable="recipient" delimiter=", ">              <label form="verb" suffix=" "/>              <name and="symbol" delimiter=", "/>            </names>          </group>          <text variable="medium" text-case="capitalize-first"/>          <choose>            <if variable="container-title" match="none">              <names variable="editor translator" delimiter="; ">                <name and="symbol" initialize-with=". " delimiter=", "/>                <label form="short" prefix=", " text-case="title"/>              </names>            </if>          </choose>        </group>      </else-if>      <else-if type="song">        <choose>          <if variable="original-author composer" match="any">            <group delimiter="; ">              <!-- Replace prefix with performer label as that becomes available -->              <names variable="author" prefix="Recorded by ">                <label form="verb" text-case="title"/>                <name and="symbol" initialize-with=". " delimiter=", "/>              </names>              <names variable="translator">                <name and="symbol" initialize-with=". " delimiter=", "/>                <label form="short" prefix=", " text-case="title"/>              </names>            </group>          </if>        </choose>      </else-if>      <else-if type="article-journal article-magazine article-newspaper" match="any">        <group delimiter="; ">          <choose>            <if variable="title">              <names variable="interviewer" delimiter="; ">                <name and="symbol" initialize-with=". " delimiter=", "/>                <label form="short" prefix=", " text-case="title"/>              </names>            </if>          </choose>          <names variable="translator" delimiter="; ">            <name and="symbol" initialize-with=". " delimiter=", "/>            <label form="short" prefix=", " text-case="title"/>          </names>        </group>      </else-if>      <else-if type="paper-conference">        <choose>          <if variable="collection-editor editor" match="any">            <text macro="secondary-contributors-booklike"/>          </if>          <else>            <group delimiter="; ">              <choose>                <if variable="title">                  <names variable="interviewer" delimiter="; ">                    <name and="symbol" initialize-with=". " delimiter=", "/>                    <label form="short" prefix=", " text-case="title"/>                  </names>                </if>              </choose>              <names variable="translator" delimiter="; ">                <name and="symbol" initialize-with=". " delimiter=", "/>                <label form="short" prefix=", " text-case="title"/>              </names>            </group>          </else>        </choose>      </else-if>      <else>        <group delimiter="; ">          <choose>            <if variable="title">              <names variable="interviewer">                <name and="symbol" initialize-with=". " delimiter="; "/>                <label form="short" prefix=", " text-case="title"/>              </names>            </if>          </choose>          <names variable="editor translator" delimiter="; ">            <name and="symbol" initialize-with=". " delimiter=", "/>            <label form="short" prefix=", " text-case="title"/>          </names>        </group>      </else>    </choose>  </macro>  <macro name="author">    <choose>      <if type="song">        <names variable="composer" delimiter=", ">          <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>          <substitute>            <names variable="original-author"/>            <names variable="author"/>            <names variable="translator">              <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>              <label form="short" prefix=" (" suffix=")" text-case="title"/>            </names>            <group delimiter=" ">              <text macro="title"/>              <text macro="description"/>              <text macro="format"/>            </group>          </substitute>        </names>      </if>      <else-if type="treaty"/>      <else>        <names variable="author" delimiter=", ">          <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>          <substitute>            <names variable="illustrator"/>            <names variable="composer"/>            <names variable="director">              <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>              <label form="long" prefix=" (" suffix=")" text-case="title"/>            </names>            <choose>              <if variable="container-title">                <choose>                  <if type="book entry entry-dictionary entry-encyclopedia" match="any">                    <text macro="title"/>                  </if>                  <else>                    <names variable="translator"/>                  </else>                </choose>                <names variable="translator">                  <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>                  <label form="short" prefix=" (" suffix=")" text-case="title"/>                </names>              </if>            </choose>            <names variable="editor translator" delimiter=", ">              <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>              <label form="short" prefix=" (" suffix=")" text-case="title"/>            </names>            <names variable="editorial-director">              <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>              <label form="short" prefix=" (" suffix=")" text-case="title"/>            </names>            <names variable="collection-editor">              <name name-as-sort-order="all" and="symbol" sort-separator=", " initialize-with=". " delimiter=", " delimiter-precedes-last="always"/>              <label form="short" prefix=" (" suffix=")" text-case="title"/>            </names>            <choose>              <if type="report">                <text variable="publisher"/>              </if>            </choose>            <group delimiter=" ">              <text macro="title"/>              <text macro="description"/>              <text macro="format"/>            </group>          </substitute>        </names>      </else>    </choose>  </macro>  <macro name="author-short">    <choose>      <if type="patent" variable="number" match="all">        <text macro="patent-number"/>      </if>      <else-if type="treaty">        <text variable="title" form="short" text-case="title"/>      </else-if>      <else-if type="personal_communication">        <choose>          <if variable="archive DOI publisher URL" match="none">            <group delimiter=", ">              <names variable="author">                <name and="symbol" delimiter=", " initialize-with=". "/>                <substitute>                  <text variable="title" form="short" text-case="title" quotes="true"/>                </substitute>              </names>              <!-- This should be localized -->              <text value="personal communication"/>            </group>          </if>          <else>            <names variable="author" delimiter=", ">              <name form="short" and="symbol" delimiter=", " initialize-with=". "/>              <substitute>                <names variable="editor"/>                <names variable="translator"/>                <choose>                  <if variable="container-title">                    <text variable="title" form="short" text-case="title" quotes="true"/>                  </if>                  <else>                    <text variable="title" form="short" text-case="title" font-style="italic"/>                  </else>                </choose>                <text macro="format-short" prefix="[" suffix="]"/>              </substitute>            </names>          </else>        </choose>      </else-if>      <else-if type="song">        <names variable="composer" delimiter=", ">          <name form="short" and="symbol" delimiter=", " initialize-with=". "/>          <substitute>            <names variable="original-author"/>            <names variable="author"/>            <names variable="translator"/>            <choose>              <if variable="container-title">                <text variable="title" form="short" text-case="title" quotes="true"/>              </if>              <else>                <text variable="title" form="short" text-case="title" font-style="italic"/>              </else>            </choose>            <text macro="format-short" prefix="[" suffix="]"/>          </substitute>        </names>      </else-if>      <else>        <names variable="author" delimiter=", ">          <name form="short" and="symbol" delimiter=", " initialize-with=". "/>          <substitute>            <names variable="illustrator"/>            <names variable="composer"/>            <names variable="director"/>            <choose>              <if variable="container-title">                <choose>                  <if type="book entry entry-dictionary entry-encyclopedia" match="any">                    <text variable="title" form="short" text-case="title" quotes="true"/>                  </if>                  <else>                    <names variable="translator"/>                  </else>                </choose>              </if>            </choose>            <names variable="editor"/>            <names variable="editorial-director"/>            <names variable="translator"/>            <choose>              <if type="report" variable="publisher" match="all">                <text variable="publisher"/>              </if>              <else-if type="legal_case">                <text variable="title" font-style="italic"/>              </else-if>              <else-if type="bill legislation" match="any">                <text variable="title" form="short" text-case="title"/>              </else-if>              <else-if variable="reviewed-author" type="review review-book" match="any">                <text macro="format-short" prefix="[" suffix="]"/>              </else-if>              <else-if type="post post-weblog webpage" variable="container-title" match="any">                <text variable="title" form="short" text-case="title" quotes="true"/>              </else-if>              <else>                <text variable="title" form="short" text-case="title" font-style="italic"/>              </else>            </choose>            <text macro="format-short" prefix="[" suffix="]"/>          </substitute>        </names>      </else>    </choose>  </macro>  <macro name="patent-number">    <!-- authority: U.S. ; genre: patent ; number: 123,445 -->    <group delimiter=" ">      <text variable="authority"/>      <choose>        <if variable="genre">          <text variable="genre" text-case="capitalize-first"/>        </if>        <else>          <!-- This should be localized -->          <text value="patent" text-case="capitalize-first"/>        </else>      </choose>      <group delimiter=" ">        <text term="issue" form="short" text-case="capitalize-first"/>        <text variable="number"/>      </group>    </group>  </macro>  <macro name="access">    <choose>      <if type="bill legal_case legislation" match="any"/>      <else-if variable="DOI" match="any">        <text variable="DOI" prefix="https://doi.org/"/>      </else-if>      <else-if variable="URL">        <group delimiter=" ">          <text term="retrieved" text-case="capitalize-first"/>          <choose>            <if type="post post-weblog webpage" match="any">              <date variable="accessed" form="text" suffix=","/>            </if>          </choose>          <text term="from"/>          <choose>            <if type="report">              <choose>                <if variable="author editor translator" match="any">                  <!-- This should be localized -->                  <text variable="publisher" suffix=" website:"/>                </if>              </choose>            </if>            <else-if type="post post-weblog webpage" match="any">              <!-- This should be localized -->              <text variable="container-title" suffix=" website:"/>            </else-if>          </choose>          <text variable="URL"/>        </group>      </else-if>      <else-if variable="archive">        <choose>          <if type="article article-journal article-magazine article-newspaper dataset paper-conference report speech thesis" match="any">            <!-- This section is for electronic database locations. Physical archives for these and other item types are called in 'publisher' macro -->            <choose>              <if variable="archive-place" match="none">                <group delimiter=" ">                  <text term="retrieved" text-case="capitalize-first"/>                  <text term="from"/>                  <text variable="archive" suffix="."/>                  <text variable="archive_location" prefix="(" suffix=")"/>                </group>              </if>            </choose>          </if>        </choose>      </else-if>    </choose>  </macro>  <macro name="title">    <choose>      <if type="treaty">        <group delimiter=", ">          <text variable="title" text-case="title"/>          <names variable="author">            <name initialize-with="." form="short" delimiter="-"/>          </names>        </group>      </if>      <else-if type="patent" variable="number" match="all">        <text macro="patent-number" font-style="italic"/>      </else-if>      <else-if variable="title">        <choose>          <if variable="version" type="book" match="all">            <!---This is a hack until we have a software type -->            <text variable="title"/>          </if>          <else-if variable="reviewed-author reviewed-title" type="review review-book" match="any">            <choose>              <if variable="reviewed-title">                <choose>                  <if type="post post-weblog webpage" variable="container-title" match="any">                    <text variable="title"/>                  </if>                  <else>                    <text variable="title" font-style="italic"/>                  </else>                </choose>              </if>            </choose>          </else-if>          <else-if type="post post-weblog webpage" variable="container-title" match="any">            <text variable="title"/>          </else-if>          <else>            <text variable="title" font-style="italic"/>          </else>        </choose>      </else-if>      <else-if variable="interviewer" type="interview" match="any">        <names variable="interviewer">          <label form="verb-short" suffix=" " text-case="capitalize-first"/>          <name and="symbol" initialize-with=". " delimiter=", "/>        </names>      </else-if>    </choose>  </macro>  <!-- APA has four descriptive sections following the title: -->  <!-- (description), [format], container, event -->  <macro name="description">    <group prefix="(" suffix=")">      <choose>        <!-- book is here to catch software with container titles -->        <if type="book report" match="any">          <choose>            <if variable="container-title">              <text macro="secondary-contributors"/>            </if>            <else>              <group delimiter="; ">                <text macro="description-report"/>                <text macro="secondary-contributors"/>              </group>            </else>          </choose>        </if>        <else-if type="thesis">          <group delimiter="; ">            <group delimiter=", ">              <text variable="genre" text-case="capitalize-first"/>              <choose>                <!-- In APA journals, the university of a thesis is always cited, even if another locator is given -->                <if variable="DOI URL archive" match="any">                  <text variable="publisher"/>                </if>              </choose>            </group>            <text macro="locators"/>            <text macro="secondary-contributors"/>          </group>        </else-if>        <else-if type="book interview manuscript motion_picture musical_score pamphlet post-weblog speech webpage" match="any">          <group delimiter="; ">            <text macro="locators"/>            <text macro="secondary-contributors"/>          </group>        </else-if>        <else-if type="song">          <choose>            <if variable="container-title" match="none">              <text macro="locators"/>            </if>          </choose>        </else-if>        <else-if type="article dataset figure" match="any">          <choose>            <if variable="container-title">              <text macro="secondary-contributors"/>            </if>            <else>              <group delimiter="; ">                <text macro="locators"/>                <text macro="secondary-contributors"/>              </group>            </else>          </choose>        </else-if>        <else-if type="bill legislation legal_case patent treaty personal_communication" match="none">          <text macro="secondary-contributors"/>        </else-if>      </choose>    </group>  </macro>  <macro name="format">    <group prefix="[" suffix="]">      <choose>        <if variable="reviewed-author reviewed-title" type="review review-book" match="any">          <group delimiter=", ">            <choose>              <if variable="genre">                <!-- Delimiting by , rather than "of" to avoid incorrect grammar -->                <group delimiter=", ">                  <text variable="genre" text-case="capitalize-first"/>                  <choose>                    <if variable="reviewed-title">                      <text variable="reviewed-title" font-style="italic"/>                    </if>                    <else>                      <!-- Assume \`title\` is title of reviewed work -->                      <text variable="title" font-style="italic"/>                    </else>                  </choose>                </group>              </if>              <else>                <!-- This should be localized -->                <group delimiter=" ">                  <text value="Review of"/>                  <choose>                    <if variable="reviewed-title">                      <text variable="reviewed-title" font-style="italic"/>                    </if>                    <else>                      <!-- Assume \`title\` is title of reviewed work -->                      <text variable="title" font-style="italic"/>                    </else>                  </choose>                </group>              </else>            </choose>            <names variable="reviewed-author">              <label form="verb-short" suffix=" "/>              <name and="symbol" initialize-with=". " delimiter=", "/>            </names>          </group>        </if>        <else>          <text macro="format-short"/>        </else>      </choose>    </group>  </macro>  <macro name="format-short">    <choose>      <if variable="reviewed-author reviewed-title" type="review review-book" match="any">        <choose>          <if variable="reviewed-title" match="none">            <choose>              <if variable="genre">                <!-- Delimiting by , rather than "of" to avoid incorrect grammar -->                <group delimiter=", ">                  <text variable="genre" text-case="capitalize-first"/>                  <text variable="title" form="short" text-case="title" font-style="italic"/>                </group>              </if>              <else>                <!-- This should be localized -->                <group delimiter=" ">                  <text value="Review of"/>                  <text variable="title" form="short" text-case="title" font-style="italic"/>                </group>              </else>            </choose>          </if>          <else>            <text variable="title" form="short" text-case="title" quotes="true"/>          </else>        </choose>      </if>      <else-if type="speech thesis" match="any">        <text variable="medium" text-case="capitalize-first"/>      </else-if>      <!-- book is here to catch software with container titles -->      <else-if type="book report" match="any">        <choose>          <if variable="container-title" match="none">            <text macro="format-report"/>          </if>        </choose>      </else-if>      <else-if type="manuscript pamphlet" match="any">        <text variable="medium" text-case="capitalize-first"/>      </else-if>      <else-if type="personal_communication">        <text macro="secondary-contributors"/>      </else-if>      <else-if type="song">        <group delimiter="; ">          <text macro="secondary-contributors"/>          <choose>            <if variable="container-title" match="none">              <group delimiter=", ">                <text variable="genre" text-case="capitalize-first"/>                <text variable="medium" text-case="capitalize-first"/>              </group>            </if>          </choose>        </group>      </else-if>      <else-if type="paper-conference">        <group delimiter=", ">          <choose>            <if variable="collection-editor editor issue page volume" match="any">              <text variable="genre" text-case="capitalize-first"/>            </if>          </choose>          <text variable="medium" text-case="capitalize-first"/>        </group>      </else-if>      <else-if type="bill legislation legal_case patent treaty" match="none">        <choose>          <if variable="genre medium" match="any">            <group delimiter=", ">              <text variable="genre" text-case="capitalize-first"/>              <text variable="medium" text-case="capitalize-first"/>            </group>          </if>          <else-if type="dataset">            <!-- This should be localized -->            <text value="Data set"/>          </else-if>        </choose>      </else-if>    </choose>  </macro>  <macro name="description-report">    <choose>      <if variable="number">        <group delimiter="; ">          <group delimiter=" ">            <text variable="genre" text-case="title"/>            <!-- Replace with term="number" if that becomes available -->            <text term="issue" form="short" text-case="capitalize-first"/>            <text variable="number"/>          </group>          <text macro="locators"/>        </group>      </if>      <else>        <text macro="locators"/>      </else>    </choose>  </macro>  <macro name="format-report">    <choose>      <if variable="number">        <text variable="medium" text-case="capitalize-first"/>      </if>      <else>        <group delimiter=", ">          <text variable="genre" text-case="capitalize-first"/>          <text variable="medium" text-case="capitalize-first"/>        </group>      </else>    </choose>  </macro>  <macro name="title-and-descriptions">    <group delimiter=" ">      <text macro="title"/>      <choose>        <if variable="title interviewer" type="interview" match="any">          <group delimiter=" ">            <text macro="description"/>            <text macro="format"/>          </group>        </if>        <else>          <group delimiter=" ">            <text macro="format"/>            <text macro="description"/>          </group>        </else>      </choose>    </group>  </macro>  <macro name="archive">    <group delimiter=". ">      <group delimiter=", ">        <choose>          <if type="manuscript">            <text variable="genre"/>          </if>        </choose>        <group delimiter=" ">          <!-- Replace "archive" with "archive_collection" as that becomes available -->          <text variable="archive"/>          <text variable="archive_location" prefix="(" suffix=")"/>        </group>      </group>      <group delimiter=", ">        <!-- Move "archive" here when "archive_collection" becomes available -->        <text variable="archive-place"/>      </group>    </group>  </macro>  <macro name="publisher">    <choose>      <if type="manuscript pamphlet" match="any">        <choose>          <if variable="archive archive_location archive-place" match="any">            <group delimiter=". ">              <group delimiter=": ">                <text variable="publisher-place"/>                <text variable="publisher"/>              </group>              <text macro="archive"/>            </group>          </if>          <else>            <group delimiter=", ">              <text variable="genre"/>              <text variable="publisher"/>              <text variable="publisher-place"/>            </group>          </else>        </choose>      </if>      <else-if type="thesis" match="any">        <group delimiter=". ">          <group delimiter=", ">            <text variable="publisher"/>            <text variable="publisher-place"/>          </group>          <text macro="archive"/>        </group>      </else-if>      <else-if type="patent">        <group delimiter=". ">          <group delimiter=": ">            <text variable="publisher-place"/>            <text variable="publisher"/>          </group>          <text macro="archive"/>        </group>      </else-if>      <else-if type="article-journal article-magazine article-newspaper" match="any">        <text macro="archive"/>      </else-if>      <else-if type="post post-weblog webpage" match="none">        <group delimiter=". ">          <choose>            <if variable="event">              <choose>                <!-- Only print publisher info if published in a proceedings -->                <if variable="collection-editor editor issue page volume" match="any">                  <group delimiter=": ">                    <text variable="publisher-place"/>                    <text variable="publisher"/>                  </group>                </if>              </choose>            </if>            <else>              <group delimiter=": ">                <text variable="publisher-place"/>                <text variable="publisher"/>              </group>            </else>          </choose>          <text macro="archive"/>        </group>      </else-if>    </choose>  </macro>  <macro name="event">    <choose>      <if variable="event" type="speech paper-conference" match="any">        <choose>          <!-- Don't print event info if published in a proceedings -->          <if variable="collection-editor editor issue page volume" match="none">            <group delimiter=" ">              <text variable="genre" text-case="capitalize-first"/>              <group delimiter=" ">                <choose>                  <if variable="genre">                    <text term="presented at"/>                  </if>                  <else>                    <text term="presented at" text-case="capitalize-first"/>                  </else>                </choose>                <group delimiter=", ">                  <text variable="event"/>                  <text variable="event-place"/>                </group>              </group>            </group>          </if>        </choose>      </if>    </choose>  </macro>  <macro name="issued">    <choose>      <if type="bill legal_case legislation" match="any"/>      <else-if variable="issued">        <group>          <date variable="issued">            <date-part name="year"/>          </date>          <text variable="year-suffix"/>          <choose>            <if type="speech">              <date variable="issued" delimiter=" ">                <date-part prefix=", " name="month"/>              </date>            </if>            <else-if type="article article-magazine article-newspaper broadcast interview pamphlet personal_communication post post-weblog treaty webpage" match="any">              <date variable="issued">                <date-part prefix=", " name="month"/>                <date-part prefix=" " name="day"/>              </date>            </else-if>            <else-if type="paper-conference">              <choose>                <if variable="container-title" match="none">                  <date variable="issued">                    <date-part prefix=", " name="month"/>                    <date-part prefix=" " name="day"/>                  </date>                </if>              </choose>            </else-if>            <!-- Only year: article-journal chapter entry entry-dictionary entry-encyclopedia dataset figure graphic motion_picture manuscript map musical_score paper-conference [published] patent report review review-book song thesis -->          </choose>        </group>      </else-if>      <else-if variable="status">        <group>          <text variable="status" text-case="lowercase"/>          <text variable="year-suffix" prefix="-"/>        </group>      </else-if>      <else>        <group>          <text term="no date" form="short"/>          <text variable="year-suffix" prefix="-"/>        </group>      </else>    </choose>  </macro>  <macro name="issued-sort">    <choose>      <if type="article article-magazine article-newspaper broadcast interview pamphlet personal_communication post post-weblog speech treaty webpage" match="any">        <date variable="issued">          <date-part name="year"/>          <date-part name="month"/>          <date-part name="day"/>        </date>      </if>      <else>        <date variable="issued">          <date-part name="year"/>        </date>      </else>    </choose>  </macro>  <macro name="issued-year">    <group>      <choose>        <if type="personal_communication">          <choose>            <if variable="archive DOI publisher URL" match="none">              <!-- These variables indicate that the letter is retrievable by the reader. If not, then use the APA in-text-only personal communication format -->              <date variable="issued" form="text"/>            </if>            <else>              <date variable="issued">                <date-part name="year"/>              </date>            </else>          </choose>        </if>        <else>          <date variable="issued">            <date-part name="year"/>          </date>        </else>      </choose>      <text variable="year-suffix"/>    </group>  </macro>  <macro name="issued-citation">    <choose>      <if variable="issued">        <group delimiter="/">          <choose>            <if is-uncertain-date="original-date">              <group prefix="[" suffix="]" delimiter=" ">                <text term="circa" form="short"/>                <date variable="original-date">                  <date-part name="year"/>                </date>              </group>            </if>            <else>              <date variable="original-date">                <date-part name="year"/>              </date>            </else>          </choose>          <choose>            <if is-uncertain-date="issued">              <group prefix="[" suffix="]" delimiter=" ">                <text term="circa" form="short"/>                <text macro="issued-year"/>              </group>            </if>            <else>              <text macro="issued-year"/>            </else>          </choose>        </group>      </if>      <else-if variable="status">        <text variable="status" text-case="lowercase"/>        <text variable="year-suffix" prefix="-"/>      </else-if>      <else>        <text term="no date" form="short"/>        <text variable="year-suffix" prefix="-"/>      </else>    </choose>  </macro>  <macro name="original-date">    <choose>      <if type="bill legal_case legislation" match="any"/>      <else-if type="speech">        <date variable="original-date" delimiter=" ">          <date-part name="month"/>          <date-part name="year"/>        </date>      </else-if>      <else-if type="article article-magazine article-newspaper broadcast interview pamphlet personal_communication post post-weblog treaty webpage" match="any">        <date variable="original-date" form="text"/>      </else-if>      <else>        <date variable="original-date">          <date-part name="year"/>        </date>      </else>    </choose>  </macro>  <macro name="original-published">    <!--This should be localized -->    <choose>      <if type="bill legal_case legislation" match="any"/>      <else-if type="interview motion_picture song" match="any">        <text value="Original work recorded"/>      </else-if>      <else-if type="broadcast">        <text value="Original work broadcast"/>      </else-if>      <else>        <text value="Original work published"/>      </else>    </choose>  </macro>  <macro name="edition">    <choose>      <if is-numeric="edition">        <group delimiter=" ">          <number variable="edition" form="ordinal"/>          <text term="edition" form="short"/>        </group>      </if>      <else>        <text variable="edition"/>      </else>    </choose>  </macro>  <macro name="locators">    <choose>      <if type="article-journal article-magazine figure review review-book" match="any">        <group delimiter=", ">          <group>            <text variable="volume" font-style="italic"/>            <text variable="issue" prefix="(" suffix=")"/>          </group>          <text variable="page"/>        </group>      </if>      <else-if type="article-newspaper">        <group delimiter=" ">          <label variable="page" form="short"/>          <text variable="page"/>        </group>      </else-if>      <else-if type="paper-conference">        <choose>          <if variable="collection-editor editor" match="any">            <text macro="locators-booklike"/>          </if>          <else>            <group delimiter=", ">              <group>                <text variable="volume" font-style="italic"/>                <text variable="issue" prefix="(" suffix=")"/>              </group>              <text variable="page"/>            </group>          </else>        </choose>      </else-if>      <else-if type="bill broadcast interview legal_case legislation patent post post-weblog speech treaty webpage" match="none">        <text macro="locators-booklike"/>      </else-if>    </choose>  </macro>  <macro name="locators-booklike">    <group delimiter=", ">      <text macro="edition"/>      <group delimiter=" ">        <text term="version" text-case="capitalize-first"/>        <text variable="version"/>      </group>      <choose>        <if variable="volume" match="any">          <choose>            <if is-numeric="volume" match="none"/>            <else-if variable="collection-title">              <choose>                <if variable="editor translator" match="none">                  <choose>                    <if variable="collection-number">                      <group>                        <text term="volume" form="short" text-case="capitalize-first" suffix=" "/>                        <number variable="volume" form="numeric"/>                      </group>                    </if>                  </choose>                </if>              </choose>            </else-if>            <else>              <group>                <text term="volume" form="short" text-case="capitalize-first" suffix=" "/>                <number variable="volume" form="numeric"/>              </group>            </else>          </choose>        </if>        <else>          <group>            <text term="volume" form="short" plural="true" text-case="capitalize-first" suffix=" "/>            <number variable="number-of-volumes" form="numeric" prefix="1&#8211;"/>          </group>        </else>      </choose>      <group>        <label variable="page" form="short" suffix=" "/>        <text variable="page"/>      </group>    </group>  </macro>  <macro name="citation-locator">    <group>      <choose>        <if locator="chapter">          <label variable="locator" text-case="capitalize-first"/>        </if>        <else>          <label variable="locator" form="short"/>        </else>      </choose>      <text variable="locator" prefix=" "/>    </group>  </macro>  <macro name="container">    <choose>      <if type="article article-journal article-magazine article-newspaper review review-book" match="any">        <group delimiter=", ">          <text macro="container-title"/>          <text macro="locators"/>        </group>        <choose>          <!--for advance online publication-->          <if variable="issued">            <choose>              <if variable="page issue" match="none">                <text variable="status" text-case="capitalize-first" prefix=". "/>              </if>            </choose>          </if>        </choose>      </if>      <else-if type="article dataset figure" match="any">        <choose>          <if variable="container-title">            <group delimiter=", ">              <text macro="container-title"/>              <text macro="locators"/>            </group>            <choose>              <!--for advance online publication-->              <if variable="issued">                <choose>                  <if variable="page issue" match="none">                    <text variable="status" text-case="capitalize-first" prefix=". "/>                  </if>                </choose>              </if>            </choose>          </if>        </choose>      </else-if>      <!-- book is here to catch software with container titles -->      <else-if type="book" variable="container-title" match="all">        <group delimiter=" ">          <text term="in" text-case="capitalize-first" suffix=" "/>          <group delimiter=", ">            <text macro="container-contributors"/>            <group delimiter=" ">              <text macro="container-title"/>              <text macro="description-report" prefix="(" suffix=")"/>              <text macro="format-report" prefix="[" suffix="]"/>            </group>          </group>        </group>      </else-if>      <else-if type="report" variable="container-title" match="all">        <group delimiter=" ">          <text term="in" text-case="capitalize-first" suffix=" "/>          <group delimiter=", ">            <text macro="container-contributors"/>            <group delimiter=" ">              <text macro="container-title"/>              <text macro="description-report" prefix="(" suffix=")"/>              <text macro="format-report" prefix="[" suffix="]"/>            </group>          </group>        </group>      </else-if>      <else-if type="song" variable="container-title" match="all">        <group delimiter=" ">          <text term="in" text-case="capitalize-first" suffix=" "/>          <group delimiter=", ">            <text macro="container-contributors"/>            <group delimiter=" ">              <text macro="container-title"/>              <text macro="locators" prefix="(" suffix=")"/>              <group delimiter=", " prefix="[" suffix="]">                <text variable="genre" text-case="capitalize-first"/>                <text variable="medium" text-case="capitalize-first"/>              </group>            </group>          </group>        </group>      </else-if>      <else-if type="paper-conference">        <choose>          <if variable="editor collection-editor container-author" match="any">            <text macro="container-booklike"/>          </if>          <else>            <group delimiter=", ">              <text macro="container-title"/>              <text macro="locators"/>            </group>          </else>        </choose>      </else-if>      <else-if type="book">        <choose>          <!-- book and software should not cite collection-title, only container-title -->          <if variable="container-title">            <text macro="container-booklike"/>          </if>        </choose>      </else-if>      <else-if type="broadcast chapter entry entry-dictionary entry-encyclopedia graphic map speech" match="any">        <text macro="container-booklike"/>      </else-if>      <else-if type="bill legal_case legislation treaty" match="any">        <text macro="legal-cites"/>      </else-if>    </choose>  </macro>  <macro name="container-booklike">    <choose>      <if variable="container-title collection-title" match="any">        <group delimiter=" ">          <text term="in" text-case="capitalize-first"/>          <group delimiter=", ">            <text macro="container-contributors"/>            <choose>              <if variable="container-author editor translator" match="none">                <group delimiter=". ">                  <group delimiter=": ">                    <text variable="collection-title" font-style="italic" text-case="title"/>                    <choose>                      <if variable="collection-title">                        <group delimiter=" ">                          <text term="volume" form="short" font-style="italic" text-case="capitalize-first"/>                          <number variable="collection-number" font-style="italic" form="numeric"/>                          <choose>                            <if variable="collection-number" match="none">                              <number variable="volume" font-style="italic" form="numeric"/>                            </if>                          </choose>                        </group>                      </if>                    </choose>                  </group>                  <!-- Replace with volume-title as that becomes available -->                  <group delimiter=": ">                    <text macro="container-title"/>                    <choose>                      <if variable="collection-title" is-numeric="volume" match="none">                        <group delimiter=" ">                          <text term="volume" form="short" font-style="italic" text-case="capitalize-first"/>                          <text variable="volume" font-style="italic"/>                        </group>                      </if>                    </choose>                  </group>                </group>              </if>              <else>                <!-- Replace with volume-title as that becomes available -->                <group delimiter=": ">                  <text macro="container-title"/>                  <choose>                    <if is-numeric="volume" match="none">                      <group delimiter=" ">                        <text term="volume" form="short" font-style="italic" text-case="capitalize-first"/>                        <text variable="volume" font-style="italic"/>                      </group>                    </if>                  </choose>                </group>              </else>            </choose>          </group>          <group delimiter="; " prefix="(" suffix=")">            <text macro="locators"/>            <names variable="container-author">              <label form="verb-short" suffix=" " text-case="title"/>              <name and="symbol" initialize-with=". " delimiter=", "/>            </names>          </group>        </group>      </if>    </choose>  </macro>  <macro name="container-title">    <choose>      <if type="article article-journal article-magazine article-newspaper dataset" match="any">        <text variable="container-title" font-style="italic" text-case="title"/>      </if>      <else-if type="paper-conference speech" match="any">        <choose>          <if variable="collection-editor container-author editor" match="any">            <text variable="container-title" font-style="italic"/>          </if>          <else>            <text variable="container-title" font-style="italic" text-case="title"/>          </else>        </choose>      </else-if>      <else-if type="bill legal_case legislation post-weblog webpage" match="none">        <text variable="container-title" font-style="italic"/>      </else-if>    </choose>  </macro>  <!-- After 'source', APA also prints publication history (original publication, reprint info, retraction info) -->  <macro name="publication-history">    <choose>      <if type="patent" match="none">        <group prefix="(" suffix=")">          <choose>            <if variable="references">              <!-- This provides the option for more elaborate description                    of publication history, such as full "reprinted" references                   (example 26) or retracted references -->              <text variable="references"/>            </if>            <else>              <choose>                <if variable="original-date">                  <group delimiter=" ">                    <text macro="original-published"/>                    <choose>                      <if is-uncertain-date="original-date">                        <group prefix="[" suffix="]" delimiter=" ">                          <text term="circa" form="short"/>                          <text macro="original-date"/>                        </group>                      </if>                      <else>                        <text macro="original-date"/>                      </else>                    </choose>                  </group>                </if>              </choose>            </else>          </choose>        </group>      </if>      <else>        <text variable="references" prefix="(" suffix=")"/>      </else>    </choose>  </macro>  <macro name="legal-cites">    <choose>      <if type="legal_case">        <group prefix=", " delimiter=" ">          <group delimiter=" ">            <choose>              <if variable="container-title">                <text variable="volume"/>                <text variable="container-title"/>                <group delimiter=" ">                  <!--change to label variable="section" as that becomes available -->                  <text term="section" form="symbol"/>                  <text variable="section"/>                </group>                <text variable="page"/>              </if>              <else>                <group delimiter=" ">                  <choose>                    <if is-numeric="number">                      <!-- Replace with term="number" if that becomes available -->                      <text term="issue" form="short" text-case="capitalize-first"/>                    </if>                  </choose>                  <text variable="number"/>                </group>              </else>            </choose>          </group>          <group prefix="(" suffix=")" delimiter=" ">            <text variable="authority"/>            <choose>              <if variable="container-title" match="any">                <!--Only print year for cases published in reporters-->                <date variable="issued" form="numeric" date-parts="year"/>              </if>              <else>                <date variable="issued" form="text"/>              </else>            </choose>          </group>        </group>      </if>      <else-if type="bill legislation" match="any">        <group prefix=", " delimiter=" ">          <group delimiter=", ">            <choose>              <if variable="number">                <!--There's a public law number-->                <text variable="number" prefix="Pub. L. No. "/>                <group delimiter=" ">                  <!--change to label variable="section" as that becomes available -->                  <text term="section" form="symbol"/>                  <text variable="section"/>                </group>                <group delimiter=" ">                  <text variable="volume"/>                  <text variable="container-title"/>                  <text variable="page-first"/>                </group>              </if>              <else>                <group delimiter=" ">                  <text variable="volume"/>                  <text variable="container-title"/>                  <!--change to label variable="section" as that becomes available -->                  <text term="section" form="symbol"/>                  <text variable="section"/>                </group>              </else>            </choose>          </group>          <date variable="issued" prefix="(" suffix=")">            <date-part name="year"/>          </date>        </group>      </else-if>      <else-if type="treaty">        <group delimiter=" ">          <number variable="volume"/>          <text variable="container-title"/>          <text variable="page"/>        </group>      </else-if>    </choose>  </macro>  <citation et-al-min="6" et-al-use-first="1" et-al-subsequent-min="3" et-al-subsequent-use-first="1" disambiguate-add-year-suffix="true" disambiguate-add-names="true" disambiguate-add-givenname="true" collapse="year" givenname-disambiguation-rule="primary-name">    <sort>      <key macro="author" names-min="8" names-use-first="6"/>      <key macro="issued-sort"/>    </sort>    <layout prefix="(" suffix=")" delimiter="; ">      <group delimiter=", ">        <text macro="author-short"/>        <text macro="issued-citation"/>        <text macro="citation-locator"/>      </group>    </layout>  </citation>  <bibliography hanging-indent="true" et-al-min="8" et-al-use-first="6" et-al-use-last="true" entry-spacing="0" line-spacing="2">    <sort>      <key macro="author"/>      <key macro="issued-sort" sort="ascending"/>      <key macro="title"/>    </sort>    <layout>      <group delimiter=" ">        <group delimiter=". " suffix=".">          <text macro="author"/>          <choose>            <if is-uncertain-date="issued">              <group prefix="[" suffix="]" delimiter=" ">                <text term="circa" form="short"/>                <text macro="issued"/>              </group>            </if>            <else>              <text macro="issued" prefix="(" suffix=")"/>            </else>          </choose>          <text macro="title-and-descriptions"/>          <text macro="container"/>          <text macro="event"/>          <text macro="publisher"/>        </group>        <text macro="access"/>        <text macro="publication-history"/>      </group>    </layout>  </bibliography></style>`;
    let vancouvername = 'citationstyle:vancouver';
    let vancouvertemplate = `<?xml version="1.0" encoding="utf-8"?><style xmlns="http://purl.org/net/xbiblio/csl" page-range-format="minimal" class="in-text" version="1.0" demote-non-dropping-particle="sort-only" default-locale="en-US">  <info>    <title>Elsevier - Vancouver (author-date)</title>    <id>http://www.zotero.org/styles/elsevier-vancouver-author-date</id>    <link href="http://www.zotero.org/styles/elsevier-vancouver-author-date" rel="self"/>    <link href="http://www.zotero.org/styles/elsevier-vancouver" rel="template"/>    <link href="https://www.elsevier.com/journals/clinical-neurophysiology/1388-2457/guide-for-authors#68000" rel="documentation"/>    <author>      <name>Sebastian Karcher</name>    </author>    <category citation-format="author-date"/>    <category field="generic-base"/>    <summary>A style for some Elsevier journals, resembles Vancouver style, but using author-date format</summary>    <updated>2019-10-15T22:06:38+00:00</updated>    <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>  </info>  <macro name="author">    <names variable="author">      <name initialize-with="" delimiter=", " delimiter-precedes-last="always" name-as-sort-order="all" sort-separator=" "/>      <label form="long" prefix=", "/>      <substitute>        <names variable="editor"/>        <names variable="translator"/>        <text variable="title"/>      </substitute>    </names>  </macro>  <macro name="author-short">    <names variable="author">      <name form="short" and="text" delimiter=", " initialize-with=". "/>      <substitute>        <names variable="editor"/>        <names variable="translator"/>        <text variable="title" form="short"/>      </substitute>    </names>  </macro>  <macro name="editor">    <names variable="editor">      <name initialize-with="" delimiter=", " delimiter-precedes-last="always" name-as-sort-order="all" sort-separator=" "/>      <label form="long" prefix=", " suffix="."/>    </names>  </macro>  <macro name="year-date">    <choose>      <if variable="issued">        <date variable="issued">          <date-part name="year"/>        </date>      </if>      <else>        <text term="no date" form="short"/>      </else>    </choose>  </macro>  <macro name="publisher">    <text variable="publisher-place" suffix=": " text-case="title"/>    <text variable="publisher" suffix="; "/>    <text macro="year-date"/>  </macro>  <macro name="edition">    <choose>      <if is-numeric="edition">        <group delimiter=" ">          <number variable="edition" form="ordinal"/>          <text term="edition" form="short"/>        </group>      </if>      <else>        <text variable="edition"/>      </else>    </choose>  </macro>  <macro name="access">    <choose>      <if variable="DOI">        <text variable="DOI" prefix="https://doi.org/"/>      </if>      <else-if type="webpage post-weblog" match="any">        <choose>          <if variable="URL">            <text variable="URL"/>            <group prefix=" (" suffix=")" delimiter=" ">              <text term="accessed"/>              <date variable="accessed" form="text"/>            </group>          </if>        </choose>      </else-if>    </choose>  </macro>  <citation et-al-min="3" et-al-use-first="1" disambiguate-add-givenname="true" disambiguate-add-year-suffix="true" collapse="year" cite-group-delimiter=", ">    <sort>      <key macro="author"/>      <key macro="year-date" sort="descending"/>    </sort>    <layout prefix="(" suffix=")" delimiter="; ">      <group delimiter=", ">        <text macro="author-short"/>        <text macro="year-date"/>        <group delimiter=" ">          <label variable="locator" form="short"/>          <text variable="locator"/>        </group>      </group>    </layout>  </citation>  <bibliography entry-spacing="0" et-al-min="7" et-al-use-first="6">    <sort>      <key macro="author"/>      <key macro="year-date" sort="descending"/>    </sort>    <layout suffix=".">      <text macro="author" suffix=". "/>      <choose>        <if type="bill book graphic legal_case legislation motion_picture report song" match="any">          <group delimiter=". ">            <text variable="title"/>            <text variable="volume" prefix="vol. "/>            <text macro="edition"/>            <text macro="publisher"/>          </group>        </if>        <else-if type="chapter paper-conference" match="any">          <group delimiter=", ">            <group delimiter=". ">              <text variable="title"/>              <group>                <text term="in" text-case="sentence" suffix=": "/>                <text macro="editor"/>              </group>              <group delimiter=", ">                <text variable="container-title" form="short"/>                <text variable="volume" prefix="vol. "/>              </group>              <text macro="edition"/>            </group>            <text macro="publisher"/>            <group delimiter=" ">              <label variable="page" form="short" plural="never"/>              <text variable="page"/>            </group>          </group>        </else-if>        <else-if type="patent">          <group delimiter=", ">            <group delimiter=". ">              <text variable="title"/>              <text variable="number"/>            </group>            <text macro="year-date"/>          </group>        </else-if>        <else-if type="thesis">          <group delimiter=". ">            <text variable="title"/>            <text variable="genre"/>            <group delimiter=", ">              <text variable="publisher"/>              <text macro="year-date"/>            </group>          </group>        </else-if>        <else>          <group delimiter=":">            <group delimiter=" ">              <group delimiter=". ">                <text variable="title"/>                <text variable="container-title" form="short" text-case="title" strip-periods="true"/>              </group>              <group delimiter=";">                <text macro="year-date"/>                <text variable="volume"/>              </group>            </group>            <text variable="page" form="short"/>          </group>        </else>      </choose>      <text macro="access" prefix=". "/>    </layout>  </bibliography></style>`;
    let mlaname = 'citationstyle:mla';
    let mlatemplate = '<?xml version="1.0" encoding="utf-8"?> <style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="never" page-range-format="minimal-two"> <info> <title>Modern Language Association 8th edition</title> <title-short>MLA</title-short> <id>http://www.zotero.org/styles/modern-language-association</id> <link href="http://www.zotero.org/styles/modern-language-association" rel="self"/> <link href="http://style.mla.org" rel="documentation"/> <author> <name>Sebastian Karcher</name> </author> <category citation-format="author"/> <category field="generic-base"/> <summary>This style adheres to the MLA 8th edition handbook. Follows the structure of references as outlined in the MLA Manual closely</summary> <updated>2018-12-13T20:05:10+00:00</updated> <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights> </info> <locale xml:lang="en"> <date form="text"> <date-part name="day" suffix=" "/> <date-part name="month" suffix=" " form="short"/> <date-part name="year"/> </date> <terms> <term name="month-01" form="short">Jan.</term> <term name="month-02" form="short">Feb.</term> <term name="month-03" form="short">Mar.</term> <term name="month-04" form="short">Apr.</term> <term name="month-05" form="short">May</term> <term name="month-06" form="short">June</term> <term name="month-07" form="short">July</term> <term name="month-08" form="short">Aug.</term> <term name="month-09" form="short">Sept.</term> <term name="month-10" form="short">Oct.</term> <term name="month-11" form="short">Nov.</term> <term name="month-12" form="short">Dec.</term> <term name="translator" form="short">trans.</term> </terms> </locale> <macro name="author"> <names variable="author"> <name name-as-sort-order="first" and="text" delimiter-precedes-last="always" delimiter-precedes-et-al="always" initialize="false" initialize-with=". "/> <label form="long" prefix=", "/> <substitute> <names variable="editor"/> <names variable="translator"/> <text macro="title"/> </substitute> </names> </macro> <macro name="author-short"> <group delimiter=", "> <names variable="author"> <name form="short" initialize-with=". " and="text"/> <substitute> <names variable="editor"/> <names variable="translator"/> <text macro="title-short"/> </substitute> </names> <choose> <if disambiguate="true"> <text macro="title-short"/> </if> </choose> </group> </macro> <macro name="title"> <choose> <if variable="container-title" match="any"> <text variable="title" quotes="true" text-case="title"/> </if> <else> <text variable="title" font-style="italic" text-case="title"/> </else> </choose> </macro> <macro name="title-short"> <choose> <if variable="container-title" match="any"> <text variable="title" form="short" quotes="true" text-case="title"/> </if> <else> <text variable="title" form="short" font-style="italic" text-case="title"/> </else> </choose> </macro> <macro name="container-title"> <text variable="container-title" font-style="italic" text-case="title"/> </macro> <macro name="other-contributors"> <group delimiter=", "> <choose> <if variable="container-title" match="any"> <names variable="illustrator interviewer editor translator" delimiter=", "> <label form="verb" suffix=" "/> <name and="text"/> </names> </if> <else> <names variable="illustrator interviewer editor translator" delimiter=", "> <label form="verb" suffix=" " text-case="capitalize-first"/> <name and="text"/> </names> </else> </choose> <names variable="director"> <label form="verb" suffix=" " text-case="capitalize-first"/> <name and="text"/> </names> </group> </macro> <macro name="version"> <group delimiter=", "> <choose> <if is-numeric="edition"> <group delimiter=" "> <number variable="edition" form="ordinal"/> <text term="edition" form="short"/> </group> </if> <else> <text variable="edition" text-case="capitalize-first"/> </else> </choose> <text variable="version"/> </group> </macro> <macro name="number"> <group delimiter=", "> <group> <choose> <if variable="edition container-title" match="any"> <group delimiter=" "> <text term="volume" form="short"/> <text variable="volume"/> </group> </if> <else-if variable="author editor" match="all"> <group delimiter=" "> <text term="volume" form="short"/> <text variable="volume"/> </group> </else-if> <else> <group delimiter=" "> <text term="volume" form="short" text-case="capitalize-first"/> <text variable="volume"/> </group> </else> </choose> </group> <group delimiter=" "> <text term="issue" form="short"/> <text variable="issue"/> </group> <choose> <if type="report"> <text variable="genre"/> </if> </choose> <text variable="number"/> </group> </macro> <macro name="publisher"> <text variable="publisher"/> </macro> <macro name="publication-date"> <choose> <if type="book chapter paper-conference motion_picture" match="any"> <date variable="issued" form="numeric" date-parts="year"/> </if> <else-if type="article-journal article-magazine" match="any"> <date variable="issued" form="text" date-parts="year-month"/> </else-if> <else-if type="speech" match="none"> <date variable="issued" form="text"/> </else-if> </choose> </macro> <macro name="location"> <group delimiter=", "> <group delimiter=" "> <label variable="page" form="short"/> <text variable="page"/> </group> <choose> <if variable="source" match="none"> <text macro="URI"/> </if> </choose> </group> </macro> <macro name="container2-title"> <group delimiter=", "> <choose> <if type="speech"> <text variable="event"/> <date variable="event-date" form="text"/> <text variable="event-place"/> </if> </choose> <text variable="archive"/> <text variable="archive-place"/> <text variable="archive_location"/> </group> </macro> <macro name="container2-location"> <choose> <if variable="source"> <choose> <if variable="DOI URL" match="any"> <group delimiter=", "> <text variable="source" font-style="italic"/> <text macro="URI"/> </group> </if> </choose> </if> </choose> </macro> <macro name="URI"> <choose> <if variable="DOI"> <text variable="DOI" prefix="doi:"/> </if> <else> <text variable="URL"/> </else> </choose> </macro> <macro name="accessed"> <choose> <if variable="issued" match="none"> <group delimiter=" "> <text term="accessed" text-case="capitalize-first"/> <date variable="accessed" form="text"/> </group> </if> </choose> </macro> <citation et-al-min="3" et-al-use-first="1" disambiguate-add-names="true" disambiguate-add-givenname="true"> <layout prefix="(" suffix=")" delimiter="; "> <choose> <if locator="page line" match="any"> <group delimiter=" "> <text macro="author-short"/> <text variable="locator"/> </group> </if> <else> <group delimiter=", "> <text macro="author-short"/> <group> <label variable="locator" form="short"/> <text variable="locator"/> </group> </group> </else> </choose> </layout> </citation> <bibliography hanging-indent="true" et-al-min="3" et-al-use-first="1" line-spacing="2" entry-spacing="0" subsequent-author-substitute="---"> <sort> <key macro="author"/> <key variable="title"/> </sort> <layout suffix="."> <group delimiter=". "> <text macro="author"/> <text macro="title"/> <date variable="original-date" form="numeric" date-parts="year"/> <group delimiter=", "> <text macro="container-title"/> <text macro="other-contributors"/> <text macro="version"/> <text macro="number"/> <text macro="publisher"/> <text macro="publication-date"/> <text macro="location"/> </group> <group delimiter=", "> <text macro="container2-title"/> <text macro="container2-location"/> </group> <text macro="accessed"/> </group> </layout> </bibliography> </style>';
    let acsname = 'citationstyle:acs';
    let acstemplate = '<?xml version="1.0" encoding="utf-8"?> <style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="sort-only" page-range-format="expanded" default-locale="en-US"> <info> <title>American Chemical Society</title> <title-short>ACS</title-short> <id>http://www.zotero.org/styles/american-chemical-society</id> <link href="http://www.zotero.org/styles/american-chemical-society" rel="self"/> <link href="http://pubs.acs.org/doi/pdf/10.1021/bk-2006-STYG.ch014" rel="documentation"/> <author> <name>Julian Onions</name> <email>julian.onions@gmail.com</email> </author> <contributor> <name>Ivan Bushmarinov</name> <email>ib@ineos.ac.ru</email> </contributor> <contributor> <name>Sebastian Karcher</name> </contributor> <category citation-format="numeric"/> <category field="chemistry"/> <summary>The American Chemical Society style</summary> <updated>2018-12-30T12:00:00+00:00</updated> <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights> </info> <locale xml:lang="en"> <terms> <term name="editortranslator" form="short"> <single>ed. and translator</single> <multiple>eds. and translators</multiple> </term> <term name="translator" form="short"> <single>translator</single> <multiple>translators</multiple> </term> <term name="collection-editor" form="short"> <single>series ed.</single> <multiple>series eds.</multiple> </term> </terms> </locale> <macro name="editor"> <group delimiter="; "> <names variable="editor translator" delimiter="; "> <name sort-separator=", " initialize-with=". " name-as-sort-order="all" delimiter=", " delimiter-precedes-last="always"/> <label form="short" prefix=", " text-case="title"/> </names> <names variable="collection-editor"> <name sort-separator=", " initialize-with=". " name-as-sort-order="all" delimiter=", " delimiter-precedes-last="always"/> <label form="short" prefix=", " text-case="title"/> </names> </group> </macro> <macro name="author"> <names variable="author" suffix="."> <name sort-separator=", " initialize-with=". " name-as-sort-order="all" delimiter="; " delimiter-precedes-last="always"/> <label form="short" prefix=", " text-case="capitalize-first"/> </names> </macro> <macro name="publisher"> <choose> <if type="thesis" match="any"> <group delimiter=", "> <text variable="publisher"/> <text variable="publisher-place"/> </group> </if> <else> <group delimiter=": "> <text variable="publisher"/> <text variable="publisher-place"/> </group> </else> </choose> </macro> <macro name="title"> <choose> <if type="bill book graphic legal_case legislation motion_picture report song" match="any"> <text variable="title" text-case="title" font-style="italic"/> </if> <else> <text variable="title" text-case="title"/> </else> </choose> </macro> <macro name="volume"> <group delimiter=" "> <text term="volume" form="short" text-case="capitalize-first"/> <text variable="volume"/> </group> </macro> <macro name="series"> <text variable="collection-title"/> </macro> <macro name="pages"> <label variable="page" form="short" suffix=" " strip-periods="true"/> <text variable="page"/> </macro> <macro name="book-container"> <group delimiter=". "> <text macro="title"/> <choose> <if type="entry-dictionary entry-encyclopedia" match="none"> <group delimiter=" "> <text term="in" text-case="capitalize-first"/> <text variable="container-title" font-style="italic"/> </group> </if> <else> <text variable="container-title" font-style="italic"/> </else> </choose> </group> </macro> <macro name="issued"> <date variable="issued" delimiter=" "> <date-part name="year"/> </date> </macro> <macro name="full-issued"> <date variable="issued" delimiter=" "> <date-part name="month" form="long" suffix=" "/> <date-part name="day" suffix=", "/> <date-part name="year"/> </date> </macro> <macro name="edition"> <choose> <if is-numeric="edition"> <group delimiter=" "> <number variable="edition" form="ordinal"/> <text term="edition" form="short"/> </group> </if> <else> <text variable="edition" suffix="."/> </else> </choose> </macro> <citation collapse="citation-number"> <sort> <key variable="citation-number"/> </sort> <layout delimiter="," vertical-align="sup"> <text variable="citation-number"/> </layout> </citation> <bibliography second-field-align="flush" entry-spacing="0" et-al-min="11" et-al-use-first="10"> <layout suffix="."> <text variable="citation-number" prefix="(" suffix=") "/> <text macro="author" suffix=" "/> <choose> <if type="article-journal review" match="any"> <group delimiter=" "> <text macro="title" suffix="."/> <text variable="container-title" font-style="italic" form="short"/> <group delimiter=", "> <text macro="issued" font-weight="bold"/> <choose> <if variable="volume"> <group delimiter=" "> <text variable="volume" font-style="italic"/> <text variable="issue" prefix="(" suffix=")"/> </group> </if> <else> <group delimiter=" "> <text term="issue" form="short" text-case="capitalize-first"/> <text variable="issue"/> </group> </else> </choose> <text variable="page"/> </group> </group> </if> <else-if type="article-magazine article-newspaper article" match="any"> <group delimiter=" "> <text macro="title" suffix="."/> <text variable="container-title" font-style="italic" suffix="."/> <text macro="edition"/> <text macro="publisher"/> <group delimiter=", "> <text macro="full-issued"/> <text macro="pages"/> </group> </group> </else-if> <else-if type="thesis"> <group delimiter=", "> <group delimiter=". "> <text macro="title"/> <text variable="genre"/> </group> <text macro="publisher"/> <text macro="issued"/> <text macro="volume"/> <text macro="pages"/> </group> </else-if> <else-if type="bill book graphic legal_case legislation motion_picture report song" match="any"> <group delimiter="; "> <group delimiter=", "> <text macro="title"/> <text macro="edition"/> </group> <text macro="editor" prefix=" "/> <text macro="series"/> <choose> <if type="report"> <group delimiter=" "> <text variable="genre"/> <text variable="number"/> </group> </if> </choose> <group delimiter=", "> <text macro="publisher"/> <text macro="issued"/> </group> <group delimiter=", "> <text macro="volume"/> <text macro="pages"/> </group> </group> </else-if> <else-if type="patent"> <group delimiter=", "> <group delimiter=". "> <text macro="title"/> <text variable="number"/> </group> <date variable="issued" form="text"/> </group> </else-if> <else-if type="chapter paper-conference entry-dictionary entry-encyclopedia" match="any"> <group delimiter="; "> <text macro="book-container"/> <text macro="editor"/> <text macro="series"/> <group delimiter=", "> <text macro="publisher"/> <text macro="issued"/> </group> <group delimiter=", "> <text macro="volume"/> <text macro="pages"/> </group> </group> </else-if> <else-if type="webpage"> <group delimiter=" "> <text variable="title"/> <text variable="URL"/> <date variable="accessed" prefix="(accessed " suffix=")" delimiter=" "> <date-part name="month" form="short" strip-periods="true"/> <date-part name="day" suffix=", "/> <date-part name="year"/> </date> </group> </else-if> <else> <group delimiter=", "> <group delimiter=". "> <text macro="title"/> <text variable="container-title" font-style="italic"/> </group> <group delimiter=", "> <text macro="issued"/> <text variable="volume" font-style="italic"/> <text variable="page"/> </group> </group> </else> </choose> <text variable="DOI" prefix=". https://doi.org/"/> </layout> </bibliography> </style>';
    let chicagoname = 'citationstyle:chicago';
    let chicagotemplate = '<?xml version="1.0" encoding="utf-8"?> <style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="display-and-sort" page-range-format="chicago"> <info> <title>Chicago Manual of Style 17th edition (author-date)</title> <id>http://www.zotero.org/styles/chicago-author-date</id> <link href="http://www.zotero.org/styles/chicago-author-date" rel="self"/> <link href="http://www.chicagomanualofstyle.org/tools_citationguide.html" rel="documentation"/> <author> <name>Julian Onions</name> <email>julian.onions@gmail.com</email> </author> <contributor> <name>Sebastian Karcher</name> </contributor> <contributor> <name>Richard Karnesky</name> <email>karnesky+zotero@gmail.com</email> <uri>http://arc.nucapt.northwestern.edu/Richard_Karnesky</uri> </contributor> <contributor> <name>Andrew Dunning</name> <email>andrew.dunning@utoronto.ca</email> <uri>https://orcid.org/0000-0003-0464-5036</uri> </contributor> <contributor> <name>Matthew Roth</name> <email>matthew.g.roth@yale.edu</email> <uri> https://orcid.org/0000-0001-7902-6331</uri> </contributor> <category citation-format="author-date"/> <category field="generic-base"/> <summary>The author-date variant of the Chicago style</summary> <updated>2018-01-24T12:00:00+00:00</updated> <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights> </info> <locale xml:lang="en"> <terms> <term name="editor" form="verb-short">ed.</term> <term name="container-author" form="verb">by</term> <term name="translator" form="verb-short">trans.</term> <term name="editortranslator" form="verb">edited and translated by</term> <term name="translator" form="short">trans.</term> </terms> </locale> <macro name="secondary-contributors"> <choose> <if type="chapter entry-dictionary entry-encyclopedia paper-conference" match="none"> <group delimiter=". "> <names variable="editor translator" delimiter=". "> <label form="verb" text-case="capitalize-first" suffix=" "/> <name and="text" delimiter=", "/> </names> <names variable="director" delimiter=". "> <label form="verb" text-case="capitalize-first" suffix=" "/> <name and="text" delimiter=", "/> </names> </group> </if> </choose> </macro> <macro name="container-contributors"> <choose> <if type="chapter entry-dictionary entry-encyclopedia paper-conference" match="any"> <group prefix=", " delimiter=", "> <names variable="container-author" delimiter=", "> <label form="verb" suffix=" "/> <name and="text" delimiter=", "/> </names> <names variable="editor translator" delimiter=", "> <label form="verb" suffix=" "/> <name and="text" delimiter=", "/> </names> </group> </if> </choose> </macro> <macro name="editor"> <names variable="editor"> <name name-as-sort-order="first" and="text" sort-separator=", " delimiter=", " delimiter-precedes-last="always"/> <label form="short" prefix=", "/> </names> </macro> <macro name="translator"> <names variable="translator"> <name name-as-sort-order="first" and="text" sort-separator=", " delimiter=", " delimiter-precedes-last="always"/> <label form="short" prefix=", "/> </names> </macro> <macro name="recipient"> <choose> <if type="personal_communication"> <choose> <if variable="genre"> <text variable="genre" text-case="capitalize-first"/> </if> <else> <text term="letter" text-case="capitalize-first"/> </else> </choose> </if> </choose> <names variable="recipient" delimiter=", "> <label form="verb" prefix=" " text-case="lowercase" suffix=" "/> <name and="text" delimiter=", "/> </names> </macro> <macro name="substitute-title"> <choose> <if type="article-magazine article-newspaper review review-book" match="any"> <text macro="container-title"/> </if> </choose> </macro> <macro name="contributors"> <group delimiter=". "> <names variable="author"> <name and="text" name-as-sort-order="first" sort-separator=", " delimiter=", " delimiter-precedes-last="always"/> <label form="short" prefix=", "/> <substitute> <names variable="editor"/> <names variable="translator"/> <names variable="director"/> <text macro="substitute-title"/> <text macro="title"/> </substitute> </names> <text macro="recipient"/> </group> </macro> <macro name="contributors-short"> <names variable="author"> <name form="short" and="text" delimiter=", " initialize-with=". "/> <substitute> <names variable="editor"/> <names variable="translator"/> <names variable="director"/> <text macro="substitute-title"/> <text macro="title"/> </substitute> </names> </macro> <macro name="interviewer"> <names variable="interviewer" delimiter=", "> <label form="verb" prefix=" " text-case="capitalize-first" suffix=" "/> <name and="text" delimiter=", "/> </names> </macro> <macro name="archive"> <group delimiter=". "> <text variable="archive_location" text-case="capitalize-first"/> <text variable="archive"/> <text variable="archive-place"/> </group> </macro> <macro name="access"> <group delimiter=". "> <choose> <if type="graphic report" match="any"> <text macro="archive"/> </if> <else-if type="article-journal bill book chapter legal_case legislation motion_picture paper-conference" match="none"> <text macro="archive"/> </else-if> </choose> <choose> <if type="webpage post-weblog" match="any"> <date variable="issued" form="text"/> </if> </choose> <choose> <if variable="issued" match="none"> <group delimiter=" "> <text term="accessed" text-case="capitalize-first"/> <date variable="accessed" form="text"/> </group> </if> </choose> <choose> <if type="legal_case" match="none"> <choose> <if variable="DOI"> <text variable="DOI" prefix="https://doi.org/"/> </if> <else> <text variable="URL"/> </else> </choose> </if> </choose> </group> </macro> <macro name="title"> <choose> <if variable="title" match="none"> <choose> <if type="personal_communication" match="none"> <text variable="genre" text-case="capitalize-first"/> </if> </choose> </if> <else-if type="bill book graphic legislation motion_picture song" match="any"> <text variable="title" text-case="title" font-style="italic"/> <group prefix=" (" suffix=")" delimiter=" "> <text term="version"/> <text variable="version"/> </group> </else-if> <else-if variable="reviewed-author"> <choose> <if variable="reviewed-title"> <group delimiter=". "> <text variable="title" text-case="title" quotes="true"/> <group delimiter=", "> <text variable="reviewed-title" text-case="title" font-style="italic" prefix="Review of "/> <names variable="reviewed-author"> <label form="verb-short" text-case="lowercase" suffix=" "/> <name and="text" delimiter=", "/> </names> </group> </group> </if> <else> <group delimiter=", "> <text variable="title" text-case="title" font-style="italic" prefix="Review of "/> <names variable="reviewed-author"> <label form="verb-short" text-case="lowercase" suffix=" "/> <name and="text" delimiter=", "/> </names> </group> </else> </choose> </else-if> <else-if type="legal_case interview patent" match="any"> <text variable="title"/> </else-if> <else> <text variable="title" text-case="title" quotes="true"/> </else> </choose> </macro> <macro name="edition"> <choose> <if type="bill book graphic legal_case legislation motion_picture report song" match="any"> <choose> <if is-numeric="edition"> <group delimiter=" " prefix=". "> <number variable="edition" form="ordinal"/> <text term="edition" form="short" strip-periods="true"/> </group> </if> <else> <text variable="edition" text-case="capitalize-first" prefix=". "/> </else> </choose> </if> <else-if type="chapter entry-dictionary entry-encyclopedia paper-conference" match="any"> <choose> <if is-numeric="edition"> <group delimiter=" " prefix=", "> <number variable="edition" form="ordinal"/> <text term="edition" form="short"/> </group> </if> <else> <text variable="edition" prefix=", "/> </else> </choose> </else-if> </choose> </macro> <macro name="locators"> <choose> <if type="article-journal"> <choose> <if variable="volume"> <text variable="volume" prefix=" "/> <group prefix=" (" suffix=")"> <choose> <if variable="issue"> <text variable="issue"/> </if> <else> <date variable="issued"> <date-part name="month"/> </date> </else> </choose> </group> </if> <else-if variable="issue"> <group delimiter=" " prefix=", "> <text term="issue" form="short"/> <text variable="issue"/> <date variable="issued" prefix="(" suffix=")"> <date-part name="month"/> </date> </group> </else-if> <else> <date variable="issued" prefix=", "> <date-part name="month"/> </date> </else> </choose> </if> <else-if type="legal_case"> <text variable="volume" prefix=", "/> <text variable="container-title" prefix=" "/> <text variable="page" prefix=" "/> </else-if> <else-if type="bill book graphic legal_case legislation motion_picture report song" match="any"> <group prefix=". " delimiter=". "> <group> <text term="volume" form="short" text-case="capitalize-first" suffix=" "/> <number variable="volume" form="numeric"/> </group> <group> <number variable="number-of-volumes" form="numeric"/> <text term="volume" form="short" prefix=" " plural="true"/> </group> </group> </else-if> <else-if type="chapter entry-dictionary entry-encyclopedia paper-conference" match="any"> <choose> <if variable="page" match="none"> <group prefix=". "> <text term="volume" form="short" text-case="capitalize-first" suffix=" "/> <number variable="volume" form="numeric"/> </group> </if> </choose> </else-if> </choose> </macro> <macro name="locators-chapter"> <choose> <if type="chapter entry-dictionary entry-encyclopedia paper-conference" match="any"> <choose> <if variable="page"> <group prefix=", "> <text variable="volume" suffix=":"/> <text variable="page"/> </group> </if> </choose> </if> </choose> </macro> <macro name="locators-article"> <choose> <if type="article-newspaper"> <group prefix=", " delimiter=", "> <group delimiter=" "> <text variable="edition"/> <text term="edition"/> </group> <group> <text term="section" form="short" suffix=" "/> <text variable="section"/> </group> </group> </if> <else-if type="article-journal"> <choose> <if variable="volume issue" match="any"> <text variable="page" prefix=": "/> </if> <else> <text variable="page" prefix=", "/> </else> </choose> </else-if> </choose> </macro> <macro name="point-locators"> <choose> <if variable="locator"> <choose> <if locator="page" match="none"> <choose> <if type="bill book graphic legal_case legislation motion_picture report song" match="any"> <choose> <if variable="volume"> <group> <text term="volume" form="short" suffix=" "/> <number variable="volume" form="numeric"/> <label variable="locator" form="short" prefix=", " suffix=" "/> </group> </if> <else> <label variable="locator" form="short" suffix=" "/> </else> </choose> </if> <else> <label variable="locator" form="short" suffix=" "/> </else> </choose> </if> <else-if type="bill book graphic legal_case legislation motion_picture report song" match="any"> <number variable="volume" form="numeric" suffix=":"/> </else-if> </choose> <text variable="locator"/> </if> </choose> </macro> <macro name="container-prefix"> <text term="in" text-case="capitalize-first"/> </macro> <macro name="container-title"> <choose> <if type="chapter entry-dictionary entry-encyclopedia paper-conference" match="any"> <text macro="container-prefix" suffix=" "/> </if> </choose> <choose> <if type="webpage"> <text variable="container-title" text-case="title"/> </if> <else-if type="legal_case" match="none"> <group delimiter=" "> <text variable="container-title" text-case="title" font-style="italic"/> <choose> <if type="post-weblog"> <text value="(blog)"/> </if> </choose> </group> </else-if> </choose> </macro> <macro name="publisher"> <group delimiter=": "> <text variable="publisher-place"/> <text variable="publisher"/> </group> </macro> <macro name="date"> <choose> <if variable="issued"> <group delimiter=" "> <date variable="original-date" form="text" date-parts="year" prefix="(" suffix=")"/> <date variable="issued"> <date-part name="year"/> </date> </group> </if> <else-if variable="status"> <text variable="status" text-case="capitalize-first"/> </else-if> <else> <text term="no date" form="short"/> </else> </choose> </macro> <macro name="date-in-text"> <choose> <if variable="issued"> <group delimiter=" "> <date variable="original-date" form="text" date-parts="year" prefix="[" suffix="]"/> <date variable="issued"> <date-part name="year"/> </date> </group> </if> <else-if variable="status"> <text variable="status"/> </else-if> <else> <text term="no date" form="short"/> </else> </choose> </macro> <macro name="day-month"> <date variable="issued"> <date-part name="month"/> <date-part name="day" prefix=" "/> </date> </macro> <macro name="collection-title"> <choose> <if match="none" type="article-journal"> <choose> <if match="none" is-numeric="collection-number"> <group delimiter=", "> <text variable="collection-title" text-case="title"/> <text variable="collection-number"/> </group> </if> <else> <group delimiter=" "> <text variable="collection-title" text-case="title"/> <text variable="collection-number"/> </group> </else> </choose> </if> </choose> </macro> <macro name="collection-title-journal"> <choose> <if type="article-journal"> <group delimiter=" "> <text variable="collection-title"/> <text variable="collection-number"/> </group> </if> </choose> </macro> <macro name="event"> <group> <text term="presented at" suffix=" "/> <text variable="event"/> </group> </macro> <macro name="description"> <choose> <if type="interview"> <group delimiter=". "> <text macro="interviewer"/> <text variable="medium" text-case="capitalize-first"/> </group> </if> <else-if type="patent"> <group delimiter=" " prefix=". "> <text variable="authority"/> <text variable="number"/> </group> </else-if> <else> <text variable="medium" text-case="capitalize-first" prefix=". "/> </else> </choose> <choose> <if variable="title" match="none"/> <else-if type="thesis personal_communication speech" match="any"/> <else> <group delimiter=" " prefix=". "> <text variable="genre" text-case="capitalize-first"/> <choose> <if type="report"> <text variable="number"/> </if> </choose> </group> </else> </choose> </macro> <macro name="issue"> <choose> <if type="legal_case"> <text variable="authority" prefix=". "/> </if> <else-if type="speech"> <group prefix=". " delimiter=", "> <group delimiter=" "> <text variable="genre" text-case="capitalize-first"/> <text macro="event"/> </group> <text variable="event-place"/> <text macro="day-month"/> </group> </else-if> <else-if type="article-newspaper article-magazine personal_communication" match="any"> <date variable="issued" form="text" prefix=", "/> </else-if> <else-if type="patent"> <group delimiter=", " prefix=", "> <group delimiter=" "> <text value="filed"/> <date variable="submitted" form="text"/> </group> <group delimiter=" "> <choose> <if variable="issued submitted" match="all"> <text term="and"/> </if> </choose> <text value="issued"/> <date variable="issued" form="text"/> </group> </group> </else-if> <else-if type="article-journal" match="any"/> <else> <group prefix=". " delimiter=", "> <choose> <if type="thesis"> <text variable="genre" text-case="capitalize-first"/> </if> </choose> <text macro="publisher"/> </group> </else> </choose> </macro> <citation et-al-min="4" et-al-use-first="1" disambiguate-add-year-suffix="true" disambiguate-add-names="true" disambiguate-add-givenname="true" givenname-disambiguation-rule="primary-name" collapse="year" after-collapse-delimiter="; "> <layout prefix="(" suffix=")" delimiter="; "> <group delimiter=", "> <choose> <if variable="issued accessed" match="any"> <group delimiter=" "> <text macro="contributors-short"/> <text macro="date-in-text"/> </group> </if> <else> <group delimiter=", "> <text macro="contributors-short"/> <text macro="date-in-text"/> </group> </else> </choose> <text macro="point-locators"/> </group> </layout> </citation> <bibliography hanging-indent="true" et-al-min="11" et-al-use-first="7" subsequent-author-substitute="&#8212;&#8212;&#8212;" entry-spacing="0"> <sort> <key macro="contributors"/> <key variable="issued"/> <key variable="title"/> </sort> <layout suffix="."> <group delimiter=". "> <text macro="contributors"/> <text macro="date"/> <text macro="title"/> </group> <text macro="description"/> <text macro="secondary-contributors" prefix=". "/> <text macro="container-title" prefix=". "/> <text macro="container-contributors"/> <text macro="edition"/> <text macro="locators-chapter"/> <text macro="collection-title-journal" prefix=", " suffix=", "/> <text macro="locators"/> <text macro="collection-title" prefix=". "/> <text macro="issue"/> <text macro="locators-article"/> <text macro="access" prefix=". "/> </layout> </bibliography> </style>';
    let harvardname = 'citationstyle:harvard';
    let harvardtemplate = `<?xml version="1.0" encoding="utf-8"?><style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0" demote-non-dropping-particle="never" default-locale="en-US">  <info>    <title>Elsevier - Harvard (with titles)</title>    <id>http://www.zotero.org/styles/elsevier-harvard</id>    <link href="http://www.zotero.org/styles/elsevier-harvard" rel="self"/>    <link href="http://www.zotero.org/styles/ecology-letters" rel="template"/>    <link href="http://www.elsevier.com/journals/biological-conservation/0006-3207/guide-for-authors#68000" rel="documentation"/>    <author>      <name>David Kaplan</name>      <email>david.kaplan@ird.fr</email>    </author>    <contributor>      <name>Simon Kornblith</name>      <email>simon@simonster.com</email>    </contributor>    <contributor>      <name>Bruce D'Arcus</name>    </contributor>    <contributor>      <name>Curtis M. Humphrey</name>    </contributor>    <contributor>      <name>Richard Karnesky</name>      <email>karnesky+zotero@gmail.com</email>      <uri>http://arc.nucapt.northwestern.edu/Richard_Karnesky</uri>    </contributor>    <contributor>      <name>Sebastian Karcher</name>    </contributor>    <category citation-format="author-date"/>    <category field="biology"/>    <category field="generic-base"/>    <updated>2014-03-04T00:09:00+00:00</updated>    <rights license="http://creativecommons.org/licenses/by-sa/3.0/">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>  </info>  <macro name="container">    <choose>      <if type="chapter paper-conference" match="any">        <text term="in" prefix=", " suffix=": "/>        <names variable="editor translator" delimiter=", " suffix=", ">          <name name-as-sort-order="all" sort-separator=", " initialize-with="." delimiter=", " delimiter-precedes-last="always"/>          <label form="short" text-case="capitalize-first" prefix=" (" suffix=")"/>        </names>        <group delimiter=", ">          <text variable="container-title" text-case="title"/>          <text variable="collection-title" text-case="title"/>        </group>      </if>      <else-if type="bill book graphic legal_case legislation motion_picture report song" match="any">        <group prefix=", " delimiter=", ">          <text variable="container-title"/>          <text variable="collection-title"/>        </group>      </else-if>      <else>        <group prefix=". " delimiter=", ">          <text variable="container-title" form="short"/>          <text variable="collection-title"/>        </group>      </else>    </choose>  </macro>  <macro name="author">    <names variable="author">      <name name-as-sort-order="all" sort-separator=", " initialize-with="." delimiter=", " delimiter-precedes-last="always"/>      <label form="short" prefix=" (" suffix=")" text-case="capitalize-first"/>      <substitute>        <names variable="editor"/>        <names variable="translator"/>        <text macro="title"/>      </substitute>    </names>  </macro>  <macro name="author-short">    <names variable="author">      <name form="short" and="text" delimiter=", " initialize-with=". "/>      <substitute>        <names variable="editor"/>        <names variable="translator"/>        <choose>          <if type="bill book graphic legal_case legislation motion_picture report song" match="any">            <text variable="title" form="short" font-style="italic"/>          </if>          <else>            <text variable="title" form="short" quotes="true"/>          </else>        </choose>      </substitute>    </names>  </macro>  <macro name="access">    <choose>      <if variable="DOI">        <text variable="DOI" prefix="https://doi.org/"/>      </if>      <else-if type="webpage post-weblog" match="any">        <group delimiter=" ">          <text value="URL"/>          <text variable="URL"/>          <group prefix="(" suffix=").">            <text term="accessed" suffix=" "/>            <date variable="accessed">              <date-part name="month" form="numeric" suffix="."/>              <date-part name="day" suffix="."/>              <date-part name="year" form="short"/>            </date>          </group>        </group>      </else-if>    </choose>  </macro>  <macro name="title">    <choose>      <if type="report thesis" match="any">        <text variable="title"/>        <group prefix=" (" suffix=")" delimiter=" ">          <text variable="genre"/>          <text variable="number" prefix="No. "/>        </group>      </if>      <else-if type="bill book graphic legal_case legislation motion_picture report song speech" match="any">        <text variable="title"/>        <text macro="edition" prefix=", "/>      </else-if>      <else-if type="webpage">        <text variable="title"/>        <text value="WWW Document" prefix=" [" suffix="]"/>      </else-if>      <else>        <text variable="title"/>      </else>    </choose>  </macro>  <macro name="publisher">    <group delimiter=", ">      <text variable="publisher"/>      <text variable="publisher-place"/>    </group>  </macro>  <macro name="event">    <choose>      <if variable="event">        <text term="presented at" text-case="capitalize-first" suffix=" "/>        <text variable="event"/>      </if>    </choose>  </macro>  <macro name="issued">    <choose>      <if variable="issued">        <date variable="issued">          <date-part name="year"/>        </date>      </if>      <else>        <text term="no date" form="short"/>      </else>    </choose>  </macro>  <macro name="edition">    <group delimiter=" ">      <choose>        <if is-numeric="edition">          <number variable="edition" form="ordinal"/>        </if>        <else>          <text variable="edition" suffix="."/>        </else>      </choose>      <text value="ed"/>    </group>  </macro>  <macro name="locators">    <choose>      <if type="article-journal article-magazine article-newspaper" match="any">        <group prefix=" " delimiter=", ">          <group>            <text variable="volume"/>          </group>          <text variable="page"/>        </group>      </if>      <else-if type="bill book graphic legal_case legislation motion_picture report song thesis" match="any">        <group delimiter=", " prefix=". ">          <text macro="event"/>          <text macro="publisher"/>        </group>      </else-if>      <else-if type="chapter paper-conference" match="any">        <group delimiter=", " prefix=". ">          <text macro="event"/>          <text macro="publisher"/>          <group>            <label variable="page" form="short" suffix=" "/>            <text variable="page"/>          </group>        </group>      </else-if>      <else-if type="patent">        <text variable="number" prefix=". "/>      </else-if>    </choose>  </macro>  <citation et-al-min="3" et-al-use-first="1" disambiguate-add-givenname="true" disambiguate-add-year-suffix="true" collapse="year" cite-group-delimiter=", ">    <sort>      <key macro="author"/>      <key macro="issued" sort="descending"/>    </sort>    <layout prefix="(" suffix=")" delimiter="; ">      <group delimiter=", ">        <text macro="author-short"/>        <text macro="issued"/>        <group delimiter=" ">          <label variable="locator" form="short"/>          <text variable="locator"/>        </group>      </group>    </layout>  </citation>  <bibliography hanging-indent="true" entry-spacing="0" line-spacing="1">    <sort>      <key macro="author"/>      <key macro="issued" sort="descending"/>    </sort>    <layout>      <group suffix=".">        <text macro="author" suffix=","/>        <text macro="issued" prefix=" "/>        <group prefix=". ">          <text macro="title"/>          <text macro="container"/>          <text macro="locators"/>        </group>      </group>      <text macro="access" prefix=". "/>    </layout>  </bibliography></style>`;
    c.plugins.config.get('@csl').templates.add(mlaname, mlatemplate);
    c.plugins.config.get('@csl').templates.add(acsname, acstemplate);
    c.plugins.config.get('@csl').templates.add(chicagoname, chicagotemplate);
    c.plugins.config.get('@csl').templates.add(vancouvername, vancouvertemplate);
    c.plugins.config.get('@csl').templates.add(harvardname, harvardtemplate);
    c.plugins.config.get('@csl').templates.add(apaname, apatemplate);
    return c;
}
